@using WorkTrackingSystem.Areas.AdminSystem.Models
@using X.PagedList.Mvc.Core
@model X.PagedList.IPagedList<WorkTrackingSystem.Areas.AdminSystem.Models.JobViewModel>
@{
    ViewData["Title"] = "Nhân viên - Công việc";
    Layout = "~/Areas/EmployeeSystem/Views/Shared/_Employee.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <ol class="breadcrumb float-sm-end bg-light">
            <li class="breadcrumb-item">Nhân viên - Công việc</li>
            <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
        </ol>
    </div>
</div>

<div class="mb-2">
    <a class="btn btn-success" asp-action="JobOfEmployee">Quay lại danh sách</a>
</div>

<div class="row mb-3">
    <div class="col-md-5">
        <div class="row">
            <div class="col-md-7">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Nhập tên công việc / hạng mục" value="@ViewBag.Search" />
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <select id="filterStatus" class="form-select text-center">
            <option value="">Tất cả trạng thái</option>
            <option value="1">Hoàn thành</option>
            <option value="2">Chưa hoàn thành</option>
            <option value="3">Hoàn thành muộn</option>
            <option value="4">Đang xử lý</option>
            <option value="0">Chưa bắt đầu</option>
        </select>
    </div>
</div>

<div id="jobTableContainer">
    @await Html.PartialAsync("_JobTablePartial", Model)
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#searchInput").on("input", function () {
                loadJobTable();
            });

            $("#filterStatus").on("change", function () {
                loadJobTable();
            });

            $("#filterStatus").val("@(ViewBag.FilterStatus ?? "")");

            // Xử lý phân trang bằng AJAX
            $(document).on("click", ".page-link", function (e) {
                e.preventDefault();
                var url = $(this).attr("href");
                loadJobTable(url);
            });
        });

        function loadJobTable(url) {
            var searchText = $("#searchInput").val();
            var selectedStatus = $("#filterStatus").val();
            var baseUrl = url || "@Url.Action("EmployeeWork", new { id = ViewBag.EmployeeId })";

            $.ajax({
                url: baseUrl,
                type: "GET",
                data: {
                    search: searchText,
                    filterStatus: selectedStatus
                },
                success: function (data) {
                    $("#jobTableContainer").html(data);
                },
                error: function () {
                    alert("Có lỗi xảy ra khi tải dữ liệu.");
                }
            });
        }
    </script>
}