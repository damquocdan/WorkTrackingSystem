 @model IEnumerable<WorkTrackingSystem.Models.Job>

@{
    ViewData["Title"] = "Danh sách công việc";
    Layout = "~/Areas/ProjectManager/Views/Shared/_ProjectManager.cshtml";
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
<div class="row">
    <h1 class="mb-4"><i class="bi bi-briefcase"></i> Danh sách công việc</h1>
    <form asp-action="Index" method="get">
        <!-- Giữ nguyên phần form tìm kiếm -->
        <div class="row mb-3">
            <div class="col-md-3">
                <input type="text" name="searchText" class="form-control" placeholder="Tìm kiếm theo mã / tên nhân viên / công việc" value="@Context.Request.Query["searchText"]">
            </div>
            <div class="col-md-2">
                <input type="month" name="month" class="form-control" value="@Context.Request.Query["month"]" />
            </div>
            <div class="col-md-2">
                <select name="status" class="form-control">
                    <option value="">-- Trạng thái --</option>
                    <option value="1">Hoàn thành</option>
                    <option value="2">Chưa hoàn thành</option>
                    <option value="3">Hoàn thành muộn</option>
                    <option value="4">Đang xử lý</option>
                    <option value="5">Chưa bắt đầu</option>
                </select>
            </div>
            <div class="col-md-1">
                <select name="categoryId" class="form-control">
                    <option value="">-- Danh mục --</option>
                    @foreach (var category in ViewData["Categories"] as List<WorkTrackingSystem.Models.Category>)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-1">
                <select name="sortOrder" class="form-control">
                    <option value="">-- Sắp xếp --</option>
                    <option value="due_asc">Hạn hoàn thành tăng dần</option>
                    <option value="due_desc">Hạn hoàn thành giảm dần</option>
                    <option value="review_asc">Đánh giá tăng dần</option>
                    <option value="review_desc">Đánh giá giảm dần</option>
                </select>
            </div>
            <div class="col-md-1">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="showCompletedZeroReview" id="showCompletedZeroReview" value="true" @(Context.Request.Query["showCompletedZeroReview"] == "true" ? "checked" : "")>
                    <label class="form-check-label" for="showCompletedZeroReview">Chưa Đ.giá</label>
                </div>
            </div>
            <div class="col-md-1">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="dueToday" id="dueToday" value="true" @(Context.Request.Query["dueToday"] == "true" ? "checked" : "")>
                    <label class="form-check-label" for="dueToday">Hạn hôm nay</label>
                </div>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i></button>
                <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-arrow-repeat"></i></a>
            </div>
        </div>
    </form>

    <div class="col-md-12" id="list-section">
        <p>
            <a id="btn-create-job" class="btn btn-primary"><i class="bi bi-plus-circle"></i>Giao công việc mới</a>
            
        </p>

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th><i class="bi bi-person"></i> Nhân viên</th>
                        <th><i class="bi bi-tag"></i> Danh mục công việc</th>
                        <th><i class="bi bi-card-heading"></i> Tên công việc</th>
                        <th><i class="bi bi-clock"></i> Hạn chót 1</th>
                        <th><i class="bi bi-clock"></i> Hạn chót 2</th>
                        <th><i class="bi bi-clock"></i> Hạn chót 3</th>
                        <th><i class="bi bi-clock"></i> Hạn hoàn thành</th>
                        <th>
                            <form asp-action="ExportToExcel" method="get">
                                <input type="hidden" name="searchText" value="@Context.Request.Query["searchText"]" />
                                <input type="hidden" name="status" value="@Context.Request.Query["status"]" />
                                <input type="hidden" name="categoryId" value="@Context.Request.Query["categoryId"]" />
                                <input type="hidden" name="dueToday" value="@Context.Request.Query["dueToday"]" />
                                <input type="hidden" name="sortOrder" value="@Context.Request.Query["sortOrder"]" />
                                <input type="hidden" name="month" value="@Context.Request.Query["month"]" />
                                <button type="submit" class="btn btn-success"><i class="bi bi-file-earmark-excel"></i> Xuất Excel</button>
                            </form>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <form id="create-job-form" asp-action="Create" asp-controller="Jobs" asp-area="ProjectManager" method="post">
                    <tr id="create-row" class="d-none">
                        <td>
                            <div class="form-group">
                                <label>Chọn nhân viên:</label>
                                <div id="employeeCheckboxGroup">
                                        @if (ViewBag.Employees != null)
                                        {
                                            @foreach (var employee in (IEnumerable<WorkTrackingSystem.Models.Employee>)ViewBag.Employees)
                                            {
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" name="EmployeeIds" value="@employee.Id" id="employee_@employee.Id">
                                                <label class="form-check-label" for="employee_@employee.Id">
                                                        @employee.Code - @employee.FirstName @employee.LastName
                                                </label>
                                            </div>
                                            }
                                        }
                                </div>
                            </div>

                        </td>
                        <td>
                            <select class="form-control" id="categorySelect" name="CategoryId">
                                <option value="">-- Chọn danh mục --</option>
                                    @foreach (var category in ViewData["Categories"] as List<WorkTrackingSystem.Models.Category>)
                                    {
                                    <option value="@category.Id">@category.Name</option>
                                    }
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control" id="jobName" name="Name" placeholder="Nhập tên công việc">
                            <h6>Mô Tả:</h6>
                            <textarea class="form-control" id="description" name="DescriptionName" placeholder="Nhập mô tả công việc" rows="5"></textarea>
                        </td>

                        <td>
                            <input type="date" class="form-control" id="deadline1" name="Deadline1">
                        </td>
                        <td>
                            <input type="date" class="form-control" id="deadline2" name="Deadline2">
                        </td>
                        <td>
                            <input type="date" class="form-control" id="deadline3" name="Deadline3">
                        </td>
                        <td>
                            <input type="date" class="form-control" id="completionDate" name="CompletionDate">
                        </td>
                        <td>
                            <button type="submit" id="save-job-btn" class="btn btn-success"><i class="bi bi-plus"></i> Thêm</button>
                            <button type="button" id="cancel-job-btn" class="btn btn-secondary"><i class="bi bi-x"></i> Hủy</button>
                        </td>
                    </tr>
                    </form>
                    
                    @foreach (var item in Model)
                    {
                        <tr class="@(item.Status == 1 ? "table-success" :
                                   item.Status == 2 ? "table-warning" :
                                   item.Status == 3 ? "table-danger" :
                                   "table-primary")">
                            <td>@Html.DisplayFor(modelItem => item.Employee.Code) @Html.DisplayFor(modelItem => item.Employee.FirstName) @Html.DisplayFor(modelItem => item.Employee.LastName)</td>
                            <td>@Html.DisplayFor(modelItem => item.Category.Name)</td>
                            <td>@Html.DisplayFor(modelItem => item.Name)</td>
                            <td>@Html.DisplayFor(modelItem => item.Deadline1)</td>
                            <td>@Html.DisplayFor(modelItem => item.Deadline2)</td>
                            <td>@Html.DisplayFor(modelItem => item.Deadline3)</td>
                            <td>@Html.DisplayFor(modelItem => item.CompletionDate)</td>
                            <td>
                                <a class="btn btn-sm btn-warning ajax-action" data-url="@Url.Action("Edit", new { id = item.Id })"><i class="bi bi-pencil-square"></i> Sửa</a>
                                <a class="btn btn-sm btn-info ajax-action" data-url="@Url.Action("Details", new { id = item.Id })"><i class="bi bi-info-circle"></i> Chi tiết</a>
                                <a class="btn btn-sm btn-danger ajax-action" data-url="@Url.Action("Delete", new { id = item.Id })"><i class="bi bi-trash"></i> Xóa</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-md-4 d-none" id="detail-section">
        <div class="actionCustomers"></div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $("#btn-create-job").click(function (e) {
            e.preventDefault();
            $("#create-row").removeClass("d-none"); // Hiển thị form nhập liệu
        });

        $("#cancel-job-btn").click(function () {
            $("#create-row").addClass("d-none"); // Ẩn form
            $("#create-job-form")[0].reset(); // Reset các giá trị trong form
        });

        $(".ajax-action").click(function (e) {
            e.preventDefault();
            var url = $(this).data("url");
            if ($("#detail-section").hasClass("d-none")) {
                $("#list-section").removeClass("col-md-12").addClass("col-md-8");
                $("#detail-section").removeClass("d-none").addClass("col-md-4");
            }
            $(".actionCustomers").load(url, function (response, status, xhr) {
                if (status === "error") {
                    alert("Lỗi khi tải dữ liệu: " + xhr.status + " " + xhr.statusText);
                }
            });
        });
    });

    function closeDetailSection() {
        $("#list-section").removeClass("col-md-8").addClass("col-md-12");
        $("#detail-section").addClass("d-none");
    }
</script>