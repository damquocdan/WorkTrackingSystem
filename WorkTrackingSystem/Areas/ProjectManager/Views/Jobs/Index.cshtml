@model IEnumerable<WorkTrackingSystem.Models.Job>

@{
    ViewData["Title"] = "Danh sách công việc";
    Layout = "~/Areas/ProjectManager/Views/Shared/_ProjectManager.cshtml";
}

<div class="row">
    <div class="col-md-12" id="list-section">
        <h1 class="mb-4"><i class="bi bi-briefcase"></i> Danh sách công việc</h1>
        <form asp-action="Index" method="get">
            <div class="row mb-3">
                <div class="col-md-3">
                    <input type="text" name="searchText" class="form-control" placeholder="Tìm kiếm theo mã / tên nhân viên / công việc" value="@Context.Request.Query["searchText"]">
                </div>
                <div class="col-md-2">
                    <select name="status" class="form-control">
                        <option value="">-- Trạng thái --</option>
                        <option value="1">Hoàn thành</option>
                        <option value="2">Chưa hoàn thành</option>
                        <option value="3">Hoàn thành muộn</option>
                        <option value="4">Đang xử lý</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select name="categoryId" class="form-control">
                        <option value="">-- Danh mục --</option>
                        @foreach (var category in ViewData["Categories"] as SelectList)
                        {
                            <option value="@category.Value">@category.Text</option>
                        }
                    </select>
                </div>

                <!-- Thêm trường chọn tháng -->
                <div class="col-md-2">
                    <input type="month" name="month" class="form-control" value="@Context.Request.Query["month"]" />
                </div>

                <div class="col-md-1">
                    <select name="sortOrder" class="form-control">
                        <option value="">-- Sắp xếp --</option>
                        <option value="due_asc">Hạn hoàn thành tăng dần</option>
                        <option value="due_desc">Hạn hoàn thành giảm dần</option>
                        <option value="review_asc">Đánh giá tăng dần</option>
                        <option value="review_desc">Đánh giá giảm dần</option>
                    </select>
                </div>

                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i></button>
                </div>
                <div class="col-md-1">
                    <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-arrow-repeat"></i></a>
                </div>
            </div>
        </form>
        <p>
            <a asp-action="Create" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Tạo mới công việc</a>
            <form asp-action="ExportToExcel" method="get">
                <input type="hidden" name="searchText" value="@Context.Request.Query["searchText"]" />
                <input type="hidden" name="status" value="@Context.Request.Query["status"]" />
                <input type="hidden" name="categoryId" value="@Context.Request.Query["categoryId"]" />
                <input type="hidden" name="dueToday" value="@Context.Request.Query["dueToday"]" />
                <input type="hidden" name="sortOrder" value="@Context.Request.Query["sortOrder"]" />
                <input type="hidden" name="month" value="@Context.Request.Query["month"]" />
                <button type="submit" class="btn btn-success"><i class="bi bi-file-earmark-excel"></i> Xuất Excel</button>
            </form>
        </p>

        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th><i class="bi bi-person"></i> Nhân viên</th>
                        <th><i class="bi bi-card-heading"></i> Tên công việc</th>
                        <th><i class="bi bi-check-square"></i> Trạng thái</th>
                        <th><i class="bi bi-journal-text"></i> Đánh giá tổng hợp</th>
                        <th><i class="bi bi-clock"></i> Hạn hoàn thành</th>
                        <th><i class="bi bi-tag"></i> Danh mục</th>

                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr class="
    @(item.Status == 1 ? "table-success " :
      item.Status == 2 ? "table-warning " :
      item.Status == 3 ? "table-danger " :
      "table-primary")">
                            <td>@Html.DisplayFor(modelItem => item.Employee.Code) @Html.DisplayFor(modelItem => item.Employee.FirstName) @Html.DisplayFor(modelItem => item.Employee.LastName)</td>
                            <td>@Html.DisplayFor(modelItem => item.Name)</td>
                            <td>
                                @switch (item.Status)
                                {
                                    case 1:
                                        <span>Hoàn thành</span>
                                        ;
                                        break;
                                    case 2:
                                        <span>Chưa hoàn thành</span>
                                        ;
                                        break;
                                    case 3:
                                        <span>Hoàn thành muộn</span>
                                        ;
                                        break;
                                    default:
                                        <span>Đang xử lý</span>
                                        ;
                                        break;
                                }
                            </td>
                            <td>@Html.DisplayFor(modelItem => item.SummaryOfReviews)</td>
                            <td>@Html.DisplayFor(modelItem => item.Time)</td>
                            <td>@Html.DisplayFor(modelItem => item.Category.Name)</td>

                            <td>
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning"><i class="bi bi-pencil-square"></i> Sửa</a>
                                <a class="btn btn-sm btn-info ajax-action" data-url="@Url.Action("Details", new { id = item.Id })"><i class="bi bi-info-circle"></i> Chi tiết</a>
                                <a class="btn btn-sm btn-danger ajax-action" data-url="@Url.Action("Delete", new { id = item.Id })"><i class="bi bi-trash"></i> Xóa</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="col-md-4 d-none" id="detail-section">
        <div class="actionCustomers"></div>
    </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $(".ajax-action").click(function (e) {
            e.preventDefault();

            var url = $(this).data("url");

            // Kiểm tra nếu phần chi tiết đang ẩn, thì thay đổi layout
            if ($("#detail-section").hasClass("d-none")) {
                $("#list-section").removeClass("col-md-12").addClass("col-md-8");
                $("#detail-section").removeClass("d-none").addClass("col-md-4");
            }

            // Load nội dung vào phần chi tiết
            $(".actionCustomers").load(url, function (response, status, xhr) {
                if (status === "error") {
                    alert("Lỗi khi tải dữ liệu: " + xhr.status + " " + xhr.statusText);
                }
            });
        });
    });
        function closeDetailSection() {
        $("#list-section").removeClass("col-md-8").addClass("col-md-12"); // Trở về full width
        $("#detail-section").addClass("d-none"); // Ẩn phần chi tiết
    }
</script>